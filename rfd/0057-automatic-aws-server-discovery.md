---
authors: Alex McGrath (alex.mcgrath@goteleport.com
state: draft
---

# RFD 57 - Automatic discovery and enrollment of AWS servers

## What

Proposes a way by which an auth service might automatically discover and
register AWS EC2 instances.

## Why

Currently when adding a new AWS server, its required that Teleport be installed
after the server has been provisioned which may be a slow process for
organizations with large numbers of servers as it needs to be installed and then
added to the teleport cluster

With the changes described in this document, Teleport will be able to resolve
the issues with adding AWS servers to Teleport clusters automatically.


## Discovery

At least one Teleport auth agent will need to be manually set up so it can can
be used to discover aws nodes.

Discovery can use a matcher similar to the `db_service/aws` matcher:

```yaml
auth_service:
  enabled: "yes"
  aws:
  - types: ["ec2"]
    regions: ["us-west-1"]
    tags:
      "teleport": "yes"
```

The agent will use EC2's `DescribeInstances` API in order to list
instance[1]. This will require the teleport auth agent to include
`ec2:DescribeInstances` as part of it's IAM permissions

As with database AWS discovery, new EC2 nodes will discovered periodically and
any new nodes will be added and existing instances updated/deleted.

EC2 `instance-id` will be used in order to avoid attempting to reinstall
Teleport on an instance where it is already available.

Example:
```json
{
  "kind": "node",
  "version": "v2",
  "metadata": {
    "labels": {
      "env": "example"
    },
  },
  "spec": {
    "public_addr": "ec2-54-194-252-215.us-west-1.compute.amazonaws.com",
    "hostname": "awsxyz"
	"aws": {
      "instance_id": "xyz123abc",
	  "account_id": "1234567890",
	  "region": "us-west-1"
	}
  }
}
```

## Agent installation

In order to install the Teleport agent on EC2 instances, the
`AWS-RunShellScript` document will be used to install and start teleport.

The installation will run the host systems package manager to install Teleport
by adding the releases repository for the appropriate system and
installing/enabling the service.

In addition a `/etc/teleport.yaml` file will be generated by running `teleport
configure --auth-server=${discovery auth agent}` via `AWS-RunShellScript`.

Initially only systems with `apt` or `yum` (Amazon Linux/RHEL, Ubuntu/Debian)
will be supported. On AWS, Amazon Linux and Ubuntu LTS (16.04, 18.04, 20.04)
come with the SSM agent preinstalled. Information on the instance's Linux distro
can be found via the `DescribeInstanceInformation` API.

## Refs:
[1]: https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html
[2]: https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html
