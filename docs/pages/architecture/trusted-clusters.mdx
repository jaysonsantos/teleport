---
title: How Trusted Clusters Work
description: Learn the architectural details of Trusted Clusters.
---
Teleport can partition compute infrastructure into multiple clusters. A cluster
is a group of Teleport resources connected to the cluster's Auth Service, which
acts as a certificate authority (CA) for all users and Nodes in the cluster.

Trusted Clusters allow the users of one cluster, the **root cluster**, to
seamlessly SSH into the Nodes of another cluster, the **leaf cluster**, while
remaining authenticated with only a single Proxy Service. The leaf cluster can
be running behind a firewall with no TCP ports open to the root cluster.

## Networking

Let's take a look at how a connection is established between the "root" cluster
and the "leaf" cluster:

![Tunnels](../../../img/tunnel.svg)

This setup works as follows: the "leaf" creates an outbound reverse SSH tunnel
to "root" and keeps the tunnel open. When a user tries to connect to a Node
inside "leaf" using the root's Proxy Service, the reverse tunnel is used to establish
this connection shown as the green line above.

**Accessibility only works in one direction.** The "leaf" cluster allows users
from "root" to access its Nodes, but users in the "leaf" cluster cannot access
the "root" cluster.


<Admonition
  type="tip"
  title="Load Balancers"
>

  The scheme above also works even if the "root" cluster uses multiple proxies
  behind a load balancer (LB) or a DNS entry with multiple values. This works by
  "leaf" establishing a tunnel to *every* proxy in "root".
  
  This requires that an LB use a round-robin or a similar balancing algorithm.
  Do not use sticky load balancing algorithms (a.k.a. "session affinity" or
  "sticky sessions") with Teleport Proxies.

</Admonition>

## Join Tokens

Let's start with a diagram of how a connection between two clusters is established:

![Tunnels](../../../img/trusted-clusters/TrustedClusters-Simple.svg)

The first step in establishing a secure tunnel between two clusters is for the
*leaf* cluster "leaf" to connect to the *root* cluster "root". When this happens
for *the first time*, clusters know nothing about each other, thus a shared
secret needs to exist for "root" to accept the connection from "leaf".

This shared secret is called a "join token". 

## RBAC

At a first glance, Trusted Clusters in combination with RBAC may seem
complicated. However, it is based on certificate-based SSH authentication
which is fairly easy to reason about.

One can think of an SSH certificate as a "permit" issued and time-stamped by a
certificate authority. A certificate contains four important pieces of data:

- List of allowed Unix logins a user can use. They are called "principals" in
  the certificate.
- Signature of the certificate authority that issued it (the Teleport Auth Service)
- Metadata (certificate extensions): additional data protected by the signature
  above. Teleport uses the metadata to store the list of user roles and SSH
  options like "permit-agent-forwarding".
- The expiration date.

Try executing `tsh status` right after `tsh login` to see all these fields in the
client certificate.

When a user from the root cluster tries to connect to a node inside "leaf", the user's
certificate is presented to the Auth Service of "leaf" and it performs the
following checks:

- Checks that the certificate signature matches one of the Trusted Clusters.
- Tries to find a local role that maps to the list of principals found in the certificate.
- Checks if the local role allows the requested identity (Unix login) to have access.
- Checks that the certificate has not expired.
